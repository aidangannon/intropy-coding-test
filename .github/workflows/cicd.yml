name: CI/CD Pipeline

on:
  push:
    branches: [ main ]
jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout head
        uses: actions/checkout@v4
      - name: Set up Python 3.11
        uses: actions/setup-python@v2
        with:
          python-version: "3.11"
      - name: Install Poetry
        run: |
          curl -sSL https://install.python-poetry.org | python3 -
          echo "$HOME/.local/bin" >> $GITHUB_PATH
      - name: Install dependencies with Poetry
        run: |
          poetry config virtualenvs.create false
          poetry install --no-interaction --no-ansi
      - name: Run tests with pytest
        run: |
          set -a
          source .env.local
          set +a
          pytest
      - name: Deploy SAM app
        env:
          DB_PASSWORD: ${{ secrets.DB_PASSWORD }}
          AWS_REGION: eu-west-2
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        run: |
          sam deploy \
            --no-fail-on-empty-changeset \
            --template-file deploy-template.yml \
            --stack-name metrics-api-prod \
            --s3-bucket metrics-api-prod-s3 \
            --s3-prefix metrics \
            --region $AWS_REGION \
            --capabilities CAPABILITY_IAM \
            --parameter-overrides DBPassword=$DB_PASSWORD KeyName=intropy-ec2-keypair \
            --no-confirm-changeset
      - name: Setup SSH key
        run: |
          echo "${{ secrets.EC2_KEY }}" > ec2_key.pem
          chmod 600 ec2_key.pem
      - name: Setup known_hosts
        run: |
          mkdir -p ~/.ssh
          ssh-keyscan -H ${{ secrets.EC2_HOST }} >> ~/.ssh/known_hosts
      - name: Copy code to EC2
        run: |
          scp -i ec2_key.pem -r ./* ec2-user@${{ secrets.EC2_HOST }}:~/app/
      - name: Deploy Docker app on EC2
        uses: appleboy/ssh-action@v0.1.7
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ec2-user
          key: ${{ secrets.EC2_KEY }}
          script: |
            set -e
            cd ~/app || mkdir ~/app && cd ~/app
            docker build -t myfastapiapp .
            if [ "$(docker ps -q -f name=myfastapiapp)" ]; then
              docker stop myfastapiapp
              docker rm myfastapiapp
            fi
            docker run -d --restart unless-stopped --name myfastapiapp --env-file /etc/fastapi.env -p 8080:8000 myfastapiapp